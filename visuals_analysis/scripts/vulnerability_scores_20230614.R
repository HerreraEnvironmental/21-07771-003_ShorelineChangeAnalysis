library(tidyverse)
source("visuals_analysis/scripts/src/functions.R")
group.colors <- c(Erosion = "#DBA827", Inundation = "#04A1FF", Both ='#3ECDA3')


## Set file pattern
file.pattern <- "20230614"

relevant.column <- c("ParkName", "Asset_Broad", "Asset_Detail",
                     "SensitivityScore", "CoastEros_Score", "CoastInund_Score", "ExposureScore", "VulnerabilityScore",
                     "Hazard_Erosion",  "Hazard_Inundation", "Hazard_FEMA", "Hazard_Any")

# Import all files --------------------------------------------------
filenames <- RemoveCsv(list.files(path = "visuals_analysis/data_raw", pattern = file.pattern))

for (i in filenames) {
  filepath <- file.path("visuals_analysis/data_raw", paste(i, ".csv", sep = ""))
  assign(make.names(i), read.csv(filepath, stringsAsFactors = FALSE, check.names = TRUE))
}

## Select columns and create feature class
polygons <- Scored_WA_Parks_Facilities_20230614_polygons %>%
  select(any_of(relevant.column)) %>%
  mutate(feature_class = "polygon")
lines <- Scored_WA_Parks_Facilities_20230614_lines %>%
  select(any_of(relevant.column)) %>%
  mutate(feature_class = "line")
points <- Scored_WA_Parks_Facilities_20230614_points %>%
  select(any_of(relevant.column)) %>%
  mutate(feature_class = "point")

## Combine to one df
parks.data <- polygons %>%
  rbind(lines) %>%
  rbind(points) 
parks.data <- parks.data[!(parks.data$ParkName=="" | parks.data$Asset_Broad=="" | parks.data$Asset_Detail==""), ]


# Graphs ------------------------------------------------------------------
## Most urgent: distribution of vulnerability scores symbolized by count,
## number of items w/ that score. What is the overall distribution?
## is it clumpy, clustered around one score?

vulnerability <- parks.data %>%
  select(VulnerabilityScore)

vulnerability.mean <- round(mean(vulnerability$VulnerabilityScore, na.rm = TRUE), digits = 2)
vulnerability.std <- round(sd(vulnerability$VulnerabilityScore, na.rm = TRUE), digits = 2)
vulnerability.quant <- quantile(vulnerability$VulnerabilityScore, na.rm = TRUE)  

# Histogram overlaid with kernel density curve
vulnerability.histogram <- ggplot(vulnerability, aes(x=VulnerabilityScore)) + 
  geom_histogram(aes(y=..density..),
                 binwidth=.5,
                 colour="black", fill="#1D455C") +
  geom_density(alpha=.2, fill='#1D455C') +
  xlab("Vulnerability Score") +
  ylab("Count") +
  ggtitle("Distribution of Coastal Facility Vulnerability Scores Across All Park Properties")
vulnerability.histogram

ggsave("visuals_analysis/figures/20230614_VulnerabilityScoreHistogram.png", vulnerability.histogram, width = 130,
       height = 130, units = "mm")

### EXPOSURE
exposure <- parks.data %>%
  select(ParkName, ExposureScore) %>%
  filter(ExposureScore != 0)

exposure.mean <- round(mean(exposure$ExposureScore, na.rm = TRUE), digits = 2)
exposure.sd <- round(sd(exposure$ExposureScore, na.rm = TRUE), digits = 2)
exposure.quant <- quantile(exposure$ExposureScore, na.rm = TRUE)  

# Histogram overlaid with kernel density curve
exposure.histogram <- ggplot(exposure, aes(x=ExposureScore)) + 
  geom_histogram(aes(y=..density..),
                 binwidth=.5,
                 colour="black", fill='#395C51') +
  geom_density(alpha=.2, fill='#1D455C') +
  xlab("Exposure Score") +
  ylab("Count") +
  ggtitle("Distribution of Coastal Facility Exposure Scores Across All Park Properties")
exposure.histogram

ggsave("~/Downloads/ExposureScore_Histogram.png", exposure.histogram, width = 130,
       height = 130, units = "mm")

### Sensitivity
sensitivity <- parks.data %>%
  select(ParkName, SensitivityScore) %>%
  filter(ParkName %in% exposure$ParkName)

sensitivity.mean <- round(mean(sensitivity$SensitivityScore, na.rm = TRUE), digits = 2)
sensitivity.sd <- round(sd(sensitivity$SensitivityScore, na.rm = TRUE), digits = 2)
sensitivity.quant <- quantile(sensitivity$SensitivityScore, na.rm = TRUE)  

# Histogram overlaid with kernel density curve
sensitivity.histogram <-ggplot(sensitivity, aes(x=SensitivityScore)) + 
  geom_histogram(aes(y=..density..),
                 binwidth=.5,
                 colour="black", fill='#FFC42E') +
  geom_density(alpha=.2, fill='#1D455C') +
  xlab("Exposure Score") +
  ylab("Count") +
  ggtitle("Distribution of Coastal Facility Sensitivity Scores Across All Park Properties")
sensitivity.histogram
ggsave("~/Downloads/SensitivityScore_Histogram.png", sensitivity.histogram, width = 130,
       height = 130, units = "mm")
